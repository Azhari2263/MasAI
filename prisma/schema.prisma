// Prisma Schema untuk MasAI - Gold Estimation System
// Database: SQLite (Production bisa diganti PostgreSQL/MySQL)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  name          String
  phone         String?
  password_hash String
  role          String   @default("USER") // USER, ADMIN, SUPER_ADMIN
  is_active     Boolean  @default(true)
  last_login    DateTime?
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  // Relations
  estimations   Estimation[]
  applications  Application[]
  audit_logs    AuditLog[]

  @@map("users")
}

model Estimation {
  id                    String   @id @default(uuid())
  estimation_id         String   @unique
  user_id               String
  object_type           String
  estimated_weight      Float
  karat                 Int
  condition             String
  confidence_scores     String   // JSON string
  gold_price_per_gram   Float
  estimated_gold_value  Float
  max_loan_amount       Float
  admin_fee             Float    @default(0)
  net_loan_amount       Float
  status                String   @default("DRAFT") // DRAFT, PENDING, PROCESSING, APPROVED, REJECTED
  image_url             String?
  created_at            DateTime @default(now())
  updated_at            DateTime @updatedAt
  expires_at            DateTime

  // Relations
  user         User          @relation(fields: [user_id], references: [id], onDelete: Cascade)
  applications Application[]

  @@map("estimations")
}

model Application {
  id                  String   @id @default(uuid())
  application_number  String   @unique
  estimation_id       String
  user_id             String
  full_name           String
  email               String
  phone               String
  branch_name         String?
  status              String   @default("PENDING") // PENDING, PROCESSING, APPROVED, REJECTED, COMPLETED
  current_step        String   @default("pengajuan_dibuat")
  progress_percentage Int      @default(0)
  approved_by         String?
  approved_at         DateTime?
  approved_amount     Float?
  rejection_reason    String?
  notes               String?
  created_at          DateTime @default(now())
  updated_at          DateTime @updatedAt

  // Relations
  user          User                    @relation(fields: [user_id], references: [id], onDelete: Cascade)
  estimation    Estimation              @relation(fields: [estimation_id], references: [id], onDelete: Cascade)
  status_logs   ApplicationStatusLog[]

  @@map("applications")
}

model ApplicationStatusLog {
  id              String   @id @default(uuid())
  application_id  String
  step            String
  status          String   // completed, in_progress, pending, failed
  description     String?
  created_by      String?
  created_at      DateTime @default(now())

  // Relations
  application Application @relation(fields: [application_id], references: [id], onDelete: Cascade)

  @@map("application_status_logs")
}

model AuditLog {
  id          String   @id @default(uuid())
  user_id     String
  action      String   // CREATE, UPDATE, DELETE, LOGIN, LOGOUT, APPROVE, REJECT
  resource    String   // user, estimation, application
  resource_id String?
  old_values  String?  // JSON string
  new_values  String?  // JSON string
  ip_address  String?
  created_at  DateTime @default(now())

  // Relations
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("audit_logs")
}

model GoldPrice {
  id          String   @id @default(uuid())
  date        DateTime @default(now())
  buy_price   Float
  sell_price  Float
  source      String   @default("Pegadaian")
  created_at  DateTime @default(now())

  @@map("gold_prices")
}